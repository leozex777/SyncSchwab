
# notification_service.py
# app.core.notification_service

"""
Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Toast Ğ² GUI.

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: st.toast() Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ Streamlit,
Ğ° sync_service Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ.

Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ (JSON Ñ„Ğ°Ğ¹Ğ»),
GUI Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ toast Ñ‡ĞµÑ€ĞµĞ· st.fragment.
"""

import json
from datetime import datetime
from pathlib import Path
from typing import List, Optional
from dataclasses import dataclass, asdict
from enum import Enum

from app.core.logger import logger


class NotificationType(Enum):
    """Ğ¢Ğ¸Ğ¿Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"""
    SUCCESS = "success"
    ERROR = "error"
    WARNING = "warning"
    INFO = "info"


@dataclass
class Notification:
    """Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ"""
    type: str
    message: str
    timestamp: str = None
    symbol: Optional[str] = None
    details: Optional[str] = None
    
    def __post_init__(self):
        if self.timestamp is None:
            self.timestamp = datetime.now().isoformat()
    
    def to_dict(self) -> dict:
        return asdict(self)
    
    @classmethod
    def from_dict(cls, data: dict) -> 'Notification':
        return cls(**data)


class NotificationService:
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"""
    
    QUEUE_FILE = Path("data/notifications_queue.json")
    MAX_QUEUE_SIZE = 50  # ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
    
    def __init__(self):
        self.QUEUE_FILE.parent.mkdir(parents=True, exist_ok=True)
    
    def _load_queue(self) -> List[dict]:
        """Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"""
        try:
            if self.QUEUE_FILE.exists():
                with open(self.QUEUE_FILE, 'r', encoding='utf-8') as f:
                    return json.load(f)
        except (json.JSONDecodeError, IOError) as e:
            logger.warning(f"Failed to load notifications queue: {e}")
        return []
    
    def _save_queue(self, queue: List[dict]):
        """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"""
        try:
            with open(self.QUEUE_FILE, 'w', encoding='utf-8') as f:
                json.dump(queue, f, indent=2, ensure_ascii=False)
        except IOError as e:
            logger.error(f"Failed to save notifications queue: {e}")
    
    def add(self, notification: Notification):
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ"""
        queue = self._load_queue()
        queue.append(notification.to_dict())
        
        # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
        if len(queue) > self.MAX_QUEUE_SIZE:
            queue = queue[-self.MAX_QUEUE_SIZE:]
        
        self._save_queue(queue)
        logger.debug(f"Notification added: {notification.type} - {notification.message}")
    
    def get_pending(self, limit: int = 10) -> List[Notification]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ pending ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ.
        
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°
        """
        queue = self._load_queue()
        
        if not queue:
            return []
        
        # Ğ’Ğ·ÑÑ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ N ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
        pending = queue[:limit]
        remaining = queue[limit:]
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ
        self._save_queue(remaining)
        
        return [Notification.from_dict(n) for n in pending]
    
    def clear(self):
        """ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ"""
        self._save_queue([])
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # HELPER METHODS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def success(self, message: str, symbol: str = None):
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ SUCCESS ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ"""
        self.add(Notification(
            type=NotificationType.SUCCESS.value,
            message=message,
            symbol=symbol
        ))
    
    def error(self, message: str, symbol: str = None, details: str = None):
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ERROR ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ"""
        self.add(Notification(
            type=NotificationType.ERROR.value,
            message=message,
            symbol=symbol,
            details=details
        ))
    
    def warning(self, message: str, symbol: str = None):
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ WARNING ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ"""
        self.add(Notification(
            type=NotificationType.WARNING.value,
            message=message,
            symbol=symbol
        ))
    
    def info(self, message: str):
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ INFO ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ"""
        self.add(Notification(
            type=NotificationType.INFO.value,
            message=message
        ))
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SYNC-SPECIFIC NOTIFICATIONS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    def sync_started(self, client_count: int, mode: str):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"""
        self.info(f"ğŸ”„ Sync started: {client_count} clients ({mode})")
    
    def sync_completed(self, success_count: int, error_count: int):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"""
        if error_count == 0:
            self.success(f"âœ… Sync completed: {success_count} orders successful")
        else:
            self.warning(f"âš ï¸ Sync completed: {success_count} success, {error_count} errors")
    
    def order_success(self, symbol: str, action: str, quantity: int):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ¾Ñ€Ğ´ĞµÑ€Ğµ"""
        self.success(f"âœ… {action} {quantity} {symbol}", symbol=symbol)
    
    def order_error(self, symbol: str, action: str, error: str):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°"""
        self.error(f"âŒ {action} {symbol}: {error}", symbol=symbol, details=error)
    
    def order_retry(self, symbol: str, attempt: int, max_attempts: int):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ retry"""
        self.warning(f"âš ï¸ Retry {attempt}/{max_attempts} for {symbol}", symbol=symbol)
    
    def critical_error(self, message: str):
        """Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ"""
        self.error(f"ğŸ›‘ CRITICAL: {message}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ­ĞšĞ—Ğ•ĞœĞŸĞ›Ğ¯Ğ 
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_notification_service: Optional[NotificationService] = None


def get_notification_service() -> NotificationService:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ NotificationService"""
    global _notification_service
    if _notification_service is None:
        _notification_service = NotificationService()
    return _notification_service


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STREAMLIT INTEGRATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def show_pending_toasts():
    """
    ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ pending ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ğº toast.
    Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· GUI (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ² st.fragment).
    
    Usage:
        import streamlit as st
        from app.core.notification_service import show_pending_toasts
        
        @st.fragment(run_every=2)
        def notification_fragment():
            show_pending_toasts()
    """
    import streamlit as st
    
    service = get_notification_service()
    notifications = service.get_pending(limit=5)
    
    for notif in notifications:
        icon = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸'
        }.get(notif.type, 'â„¹ï¸')
        
        st.toast(f"{icon} {notif.message}")
